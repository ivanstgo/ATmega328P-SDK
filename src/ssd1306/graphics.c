#include "graphics.h"
#include <avr/pgmspace.h>

const unsigned char font[480] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, 0x03, 0x00, 0x03, 0x00, 0x14,
    0x3e, 0x14, 0x3e, 0x14, 0x46, 0x49, 0x7f, 0x49, 0x31, 0x23, 0x13, 0x08, 0x64, 0x62, 0x36, 0x49,
    0x55, 0x22, 0x50, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x3e, 0x41, 0x00, 0x00, 0x00, 0x00, 0x41,
    0x3e, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x08, 0x08, 0x3e, 0x08, 0x08, 0x00, 0x40, 0x20, 0x00,
    0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x40, 0x00, 0x00, 0x20, 0x10, 0x08, 0x04, 0x02,
    0x3e, 0x51, 0x49, 0x45, 0x3e, 0x00, 0x42, 0x7f, 0x40, 0x00, 0x62, 0x51, 0x49, 0x49, 0x46, 0x22,
    0x41, 0x49, 0x49, 0x36, 0x18, 0x14, 0x12, 0x11, 0x7f, 0x27, 0x45, 0x45, 0x45, 0x39, 0x3e, 0x49,
    0x49, 0x49, 0x32, 0x01, 0x71, 0x09, 0x05, 0x03, 0x36, 0x49, 0x49, 0x49, 0x36, 0x26, 0x49, 0x49,
    0x49, 0x3e, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x40, 0x22, 0x00, 0x00, 0x00, 0x08, 0x14, 0x22,
    0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x22, 0x14, 0x08, 0x00, 0x02, 0x01, 0x51, 0x09, 0x06,
    0x3e, 0x41, 0x49, 0x55, 0x5e, 0x7e, 0x09, 0x09, 0x09, 0x7f, 0x7f, 0x49, 0x49, 0x49, 0x36, 0x3e,
    0x41, 0x41, 0x41, 0x22, 0x7f, 0x41, 0x41, 0x41, 0x3e, 0x7f, 0x49, 0x49, 0x49, 0x41, 0x7f, 0x09,
    0x09, 0x09, 0x01, 0x3e, 0x41, 0x41, 0x51, 0x32, 0x7f, 0x08, 0x08, 0x08, 0x7f, 0x00, 0x41, 0x7f,
    0x41, 0x00, 0x20, 0x40, 0x40, 0x41, 0x3f, 0x7f, 0x08, 0x14, 0x22, 0x41, 0x7f, 0x40, 0x40, 0x40,
    0x40, 0x7f, 0x02, 0x04, 0x02, 0x7f, 0x7f, 0x04, 0x08, 0x10, 0x7f, 0x3e, 0x41, 0x41, 0x41, 0xbe,
    0x7f, 0x09, 0x09, 0x09, 0x06, 0x3e, 0x41, 0x51, 0x21, 0x5e, 0x7f, 0x09, 0x09, 0x09, 0x76, 0x26,
    0x49, 0x49, 0x49, 0x32, 0x01, 0x01, 0x7f, 0x01, 0x01, 0x3f, 0x40, 0x40, 0x40, 0x3f, 0x1f, 0x20,
    0x40, 0x20, 0x1f, 0x3f, 0x40, 0x30, 0x40, 0x3f, 0x63, 0x14, 0x08, 0x14, 0x63, 0x03, 0x04, 0x78,
    0x04, 0x03, 0x61, 0x51, 0x49, 0x45, 0x43, 0x00, 0x7f, 0x41, 0x00, 0x00, 0x02, 0x04, 0x08, 0x10,
    0x20, 0x00, 0x00, 0x41, 0x7f, 0x00, 0x04, 0x02, 0x01, 0x02, 0x04, 0x40, 0x40, 0x40, 0x40, 0x40,
    0x00, 0x01, 0x02, 0x00, 0x00, 0x20, 0x54, 0x54, 0x78, 0x00, 0x7f, 0x48, 0x48, 0x30, 0x00, 0x38,
    0x44, 0x44, 0x28, 0x00, 0x30, 0x48, 0x48, 0x7f, 0x00, 0x38, 0x54, 0x54, 0x18, 0x00, 0x7e, 0x09,
    0x09, 0x02, 0x00, 0x4c, 0x52, 0x52, 0x3e, 0x00, 0x7f, 0x08, 0x08, 0x70, 0x00, 0x00, 0x00, 0x7d,
    0x00, 0x00, 0x00, 0x20, 0x40, 0x3d, 0x00, 0x7f, 0x08, 0x14, 0x62, 0x00, 0x00, 0x00, 0x3f, 0x40,
    0x00, 0x7c, 0x04, 0x7c, 0x04, 0x78, 0x7c, 0x04, 0x04, 0x78, 0x00, 0x38, 0x44, 0x44, 0x38, 0x00,
    0x7c, 0x12, 0x12, 0x0c, 0x00, 0x0c, 0x12, 0x12, 0x7c, 0x00, 0x7c, 0x08, 0x04, 0x04, 0x00, 0x48,
    0x54, 0x54, 0x24, 0x00, 0x04, 0x3f, 0x44, 0x44, 0x00, 0x3c, 0x40, 0x40, 0x7c, 0x00, 0x1c, 0x20,
    0x40, 0x20, 0x1c, 0x3c, 0x40, 0x20, 0x40, 0x3c, 0x6c, 0x10, 0x10, 0x6c, 0x00, 0x0e, 0x50, 0x50,
    0x3e, 0x00, 0x64, 0x54, 0x54, 0x4c, 0x00, 0x00, 0x08, 0x36, 0x41, 0x41, 0x00, 0x00, 0x3e, 0x00,
    0x00, 0x41, 0x41, 0x36, 0x08, 0x00, 0x08, 0x04, 0x08, 0x04, 0x00, 0x7f, 0x7d, 0x55, 0x79, 0x7f};

void draw_text(Graphics *g, const char *string, unsigned int r, unsigned int c)
{
    int i = 0;
    while (*(string + i))
    {
        for (int j = 0; j < 5; j++)
        {
            g->buffer[(r << 7) + ((c + i) * 6) + j + 1] |= pgm_read_byte(&font[(*(string + i) - 32) * 5 + j]);
        }
        i++;
    }
}

void draw_image(Graphics *g, const unsigned char *image, unsigned int w, unsigned int length, unsigned int r, unsigned int x)
{
    int j = 0;
    for (int i = 0; i < length; i++)
    {
        if (!(i % w))
        {
            r++;
            j = 0;
        }
        g->buffer[(r << 7) + x + j] |= pgm_read_byte(&image[i]);
        j++;
    }
}

void clear_graphics(Graphics *g)
{
    for (int i = 0; i < 1024; i++)
        g->buffer[i] = 0x00;
}

void draw_pixel(Graphics *g, unsigned int x, unsigned int y)
{
    if (x < 128 && y < 64)
        g->buffer[x + ((y >> 3) << 7)] |= 1 << (y - ((y >> 3) << 3));
}

void draw_line(Graphics *g, unsigned int x1, unsigned int y1, unsigned int x2, unsigned int y2)
{
    int x = x1;
    int y = y1;
    int dx = x2 - x1;
    int dy = y2 - y1;
    int s1, s2;
    if (dx < 0)
    {
        s1 = -1;
        dx = -dx;
    }
    else if (dx > 0)
    {
        s1 = 1;
    }
    else
    {
        s1 = 0;
    }
    if (dy < 0)
    {
        s2 = -1;
        dy = -dy;
    }
    else if (dy > 0)
    {
        s2 = 1;
    }
    else
    {
        s2 = 0;
    }
    int inverted = 0;
    if (dy > dx)
    {
        int temp = dx;
        dx = dy;
        dy = temp;
        inverted = 1;
    }
    int e = 2 * (dy - dx);
    int a = 2 * dy;
    int b = 2 * (dy - dx);
    draw_pixel(g, (unsigned int)x, (unsigned int)y);
    for (int i = 1; i <= dx; i++)
    {
        if (e < 0)
        {
            if (inverted)
            {
                y += s2;
            }
            else
            {
                x += s1;
            }
            e += a;
        }
        else
        {
            y += s2;
            x += s1;
            e += b;
        }
        draw_pixel(g, (unsigned int)x, (unsigned int)y);
    }
}

void draw_circle(Graphics *g, unsigned int xc, unsigned int yc, unsigned int r)
{
    int x = r;
    int y = 0;
    draw_pixel(g, x + xc, y + yc);
    if (r > 0)
    {
        draw_pixel(g, y + xc, x + yc);
        draw_pixel(g, y + xc, yc - x);
        draw_pixel(g, xc - x, y + yc);
        int p = 1 - r;
        while (x > y)
        {
            y++;
            if (p <= 0)
                p += 2 * (y + 1);
            else
            {
                x--;
                p += (2 * (y - x)) + 1;
            }
            if (x < y)
                break;
            draw_pixel(g, x + xc, y + yc);
            draw_pixel(g, xc - x, y + yc);
            draw_pixel(g, x + xc, yc - y);
            draw_pixel(g, xc - x, yc - y);
            if (x != y)
            {
                draw_pixel(g, y + xc, x + yc);
                draw_pixel(g, xc - y, x + yc);
                draw_pixel(g, y + xc, yc - x);
                draw_pixel(g, xc - y, yc - x);
            }
        }
    }
}

void draw_triangle(Graphics *g, unsigned int x1, unsigned int y1, unsigned int x2, unsigned int y2, unsigned int x3, unsigned int y3)
{
    draw_line(g, x1, y1, x2, y2);
    draw_line(g, x2, y2, x3, y3);
    draw_line(g, x3, y3, x1, y1);
}

void draw_rectangle(Graphics *g, unsigned int x, unsigned int y, unsigned int w, unsigned int h)
{
    draw_line(g, x, y, x + w, y);
    draw_line(g, x + w, y, x + w, y + h);
    draw_line(g, x + w, y + h, x, y + h);
    draw_line(g, x, y + h, x , y);
}

void draw_polygon(Graphics *g, unsigned int *x, unsigned int *y, unsigned int n)
{
    for (int i = 0; i < (n - 1); i++)
        draw_line(g, *(x + i), *(y + i), *(x + i + 1), *(y + i + 1));
    draw_line(g, *(x + n - 1), *(y + n - 1), *x, *y);
}

void draw_polyline(Graphics *g, unsigned int *x, unsigned int *y, unsigned int n)
{
    for (int i = 0; i < (n - 1); i++)
        draw_line(g, *(x + i), *(y + i), *(x + i + 1), *(y + i + 1));
}